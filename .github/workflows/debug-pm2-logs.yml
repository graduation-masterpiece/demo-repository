name: Debug PM2 Logs on EC2

on:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ íŠ¸ë¦¬ê±°

jobs:
  debug:
    runs-on: ubuntu-latest

    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Add EC2 to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: SSH to EC2 and Show PM2 Logs
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << 'EOF'
            echo "âœ… í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ PM2 í”„ë¡œì„¸ìŠ¤ ëª©ë¡"
            pm2 list || echo "PM2ê°€ ì„¤ì¹˜ë˜ì–´ ìžˆì§€ ì•Šê±°ë‚˜ ì‹¤í–‰ ì¤‘ì¸ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤."

            echo ""
            echo "ðŸ“¦ bookcard ì•± ìµœê·¼ ë¡œê·¸ ì¶œë ¥ (100ì¤„)"
            pm2 logs bookcard --lines 100 || echo "bookcard ì•± ë¡œê·¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

            echo ""
            echo "ðŸ“ í˜„ìž¬ ì„œë²„ ë””ë ‰í† ë¦¬ í™•ì¸"
            pwd && ls -al

            echo ""
            echo "ðŸŒ í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸ í™•ì¸"
            sudo lsof -i -P -n | grep LISTEN || echo "í¬íŠ¸ ì—´ë¦¼ ì •ë³´ ì—†ìŒ"
          EOF
